
## Step 1: Set up the Goal of Analysis

The main objective is to provide a comprehensive analysis of the simulation outputs to identify trends and relationships in malaria transmission. This involves using the outputs generated by the simulation and applying analyzers to derive insights into epidemiological metrics like parasite prevalence and transmission trends.


## Step 2: Requirements Overview

### 1. Location File
   - **File Name**: `example_site.csv`
   - **Description**: This file contains the coordinates (latitude and longitude) of the sites where the simulations will be run. It provides the geographical context, allowing for the integration of site-specific characteristics into the simulation.
   

### 2. Climate Data
   - **Description**: Essential for realistic simulation modeling, the climate data includes:
     - Air Temperature
     - Land Surface Temperature
     - Rainfall Data
     - Relative Humidity

### 3. Extract Weather Data Script
   - **File Name**: `extract_weather.py`
   - **Purpose**: This script extracts relevant climate data for each of the simulation sites from raw datasets. It processes large datasets to obtain only the relevant climate information for the specified locations.


### 4. Recreate Weather CSV Script
   - **File Name**: `recreate_weather.py`
   - **Purpose**: Converts extracted weather files into CSV format, making them easier to merge and visualize for the rest of the pipeline.


### 5. Manifest File
   - **File Name**: `manifest.py`
   - **Purpose**: Stores configuration settings and paths for all necessary files to run the simulation and analysis seamlessly.


### 6. Run Simulation Script
   - **File Name**: `run_example.py`
   - **Purpose**: Runs the entire simulation process using inputs from the location file, weather CSV, and manifest settings.


### 7. Analyzers
   - **InsetChatAnalyzer & MonthlyPfPRAnalyzer**
     - **Purpose**: Analyze the outputs from the simulations. InsetChatAnalyzer captures detailed time-series results, while MonthlyPfPRAnalyzer computes the Monthly Parasite Prevalence Rate (PfPR). This metric is crucial for understanding the malaria transmission intensity at each site.


## File Structure

- `example_site.csv`: Geographical location information of the simulation sites.
- `extract_weather.py`: Extracts required weather data from raw datasets.
- `recreate_weather.py`: Converts extracted weather data into a compatible CSV format.
- `manifest.py`: Stores configuration settings and file paths.
- `run_example.py`: Executes the entire simulation using the provided inputs.
- `InsetChatAnalyzer` & `MonthlyPfPRAnalyzer`: Analyze the simulation outputs to derive meaningful epidemiological insights.

## Usage

1. **Prepare Input Files**: Ensure the location and climate data are properly formatted as per the requirements.
2. **Run Weather Data Extraction**: Use `extract_weather.py` to extract the required weather data for each site.
3. **Convert Weather Data to CSV**: Use `recreate_weather.py` to convert the extracted data into CSV format.
4. **Configure Manifest File**: Update the `manifest.py` file with the paths to input files and configuration settings.
5. **Run Simulation**: Execute the `run_example.py` script to start the simulation.
6. **Analyze Outputs**: Use InsetChatAnalyzer and MonthlyPfPRAnalyzer to analyze the simulation results.


## Step 3: Run the extract_weather.py to run the weather generator and extract the files
**python3 extract_weather.py**

## Step 4: Run the recreate_weather.py to convert the weather files to csv

## Step 5: Add inputs and outputs to the script that runs the simulation

#### 1. Import Required Libraries
```python
import pathlib
import os
from functools import partial
```
- `pathlib`: Used for file system paths to handle files and directories in a more abstract way.
- `os`: Provides a way of using operating system-dependent functionality like reading environment variables, managing paths, etc.
- `partial` from `functools`: Used for creating partial functions that fix a portion of a function's arguments, enabling more convenient use later.

```python
#idmtools   
from idmtools.assets import Asset, AssetCollection  
from idmtools.builders import SimulationBuilder
from idmtools.core.platform_factory import Platform
from idmtools.entities.experiment import Experiment
```
- **idmtools assets** (`Asset`, `AssetCollection`): Used for managing assets (files) that are required by simulations.
- **SimulationBuilder**: Helps in setting up different combinations of simulation parameters.
- **Platform**: Used for configuring the environment (like SLURM) in which the simulation will be run.
- **Experiment**: Represents an experiment, which is a set of simulations sharing common characteristics.

```python
#emodpy
from emodpy.emod_task import EMODTask
from emodpy.utils import EradicationBambooBuilds
from emodpy.bamboo import get_model_files
import emod_api.config.default_from_schema_no_validation as dfs
import emod_api.campaign as camp
```
- **EMODTask**: Represents a task in the EMOD (Epidemiological MODel) simulation.
- **EradicationBambooBuilds** and **get_model_files**: Utilities for accessing model files from Bamboo, which is a build tool.
- **default_from_schema_no_validation** (`dfs`): Used for creating default configuration files without validation.
- **campaign** (`camp`): For creating campaign files that define interventions.

```python
#emodpy-malaria
import emodpy_malaria.demographics.MalariaDemographics as Demographics
```
- **MalariaDemographics**: For defining the demographic characteristics of the population for malaria simulations.

```python
import manifest
```
- **manifest**: Imports paths and configuration settings needed for running the simulation.

#### 2. Define Simulation Duration and Configuration Function
```python
sim_years = 1
```
- Defines the number of years (`sim_years`) that the simulation will run. Here, it is set to 1 year.

```python
def set_param_fn(config):
    """
    This function is a callback that is passed to emod-api.config to set config parameters, including the malaria defaults.
    """
    import emodpy_malaria.malaria_config as conf
```
- **set_param_fn(config)**: Defines a function to customize the configuration settings for the simulation.
- Imports `malaria_config` for setting malaria-specific configurations.

```python
    config = conf.set_team_defaults(config, manifest)
```
- Sets default parameters for the malaria model based on team-specific requirements using the **manifest** file.

```python
    ## Add climate data
    config.parameters.Climate_Model = "CLIMATE_BY_DATA"
```
- **Climate_Model** is set to `"CLIMATE_BY_DATA"` to use climate data files as input to the model.

```python
    config.parameters.Air_Temperature_Filename = os.path.join('climate', 'example_air_temperature_daily.bin')
    config.parameters.Land_Temperature_Filename = os.path.join('climate', 'example_air_temperature_daily.bin')
    config.parameters.Rainfall_Filename = os.path.join('climate', 'example_rainfall_daily.bin')
    config.parameters.Relative_Humidity_Filename = os.path.join('climate', 'example_relative_humidity_daily.bin')
```
- Specifies the filenames for different climate parameters (air temperature, land temperature, rainfall, and relative humidity). These files provide essential input to the model for weather conditions.

```python
    ## Add species
    conf.add_species(config, manifest, ["gambiae", "arabiensis", "funestus"])
```
- Adds mosquito species (`gambiae`, `arabiensis`, and `funestus`) that are involved in malaria transmission.

```python
    config.parameters.Simulation_Duration = sim_years * 365
    config.parameters.Run_Number = 0
```
- Sets the **simulation duration** in days (1 year Ã— 365 days).
- **Run_Number** is set to `0` to indicate the first run.

```python
    return config
```
- Returns the modified configuration object.

#### 3. Build Campaign File (`build_camp`)
```python
def build_camp():
    """
    This function builds a campaign input file for the DTK using emod_api.
    """
    camp.set_schema(manifest.schema_file)
    return camp
```
- **build_camp()**: Builds the campaign input file using **emod_api**.
- Sets the **schema** for the campaign based on the schema file in the **manifest**.
- Returns the campaign object.

#### 4. Build Demographics File (`build_demog`)
```python
def build_demog():
    """
    This function builds a demographics input file for the DTK using emod_api.
    """
    demog = Demographics.from_template_node(lat=0.4479, lon=33.2026, pop=1000, name="Example_Site")
```
- **build_demog()**: Creates a demographics input file using **MalariaDemographics**.
- **from_template_node()**: Creates a node at the specified latitude and longitude (`lat=0.4479`, `lon=33.2026`) with a population size of `1000`.

```python
    demog.SetEquilibriumVitalDynamics()
```
- Sets **equilibrium vital dynamics** for the population, meaning birth and death rates are balanced.

```python
    age_distribution = Distributions.AgeDistribution_SSAfrica
    demog.SetAgeDistribution(age_distribution)
```
- Uses an age distribution appropriate for **Sub-Saharan Africa** and sets it for the demographics.

```python
    return demog
```
- Returns the demographics object.

#### 5. General Simulation Function (`general_sim`)
```python
def general_sim(selected_platform):
    """
    This function is designed to be a parameterized version of the sequence of things we do 
    every time we run an emod experiment. 
    """
    platform = Platform(selected_platform, job_directory=manifest.job_directory, partition='b1139testnode', time='2:00:00', account='b1139', modules=['singularity'], max_running_jobs=10)
```
- **general_sim()**: Main function for running the experiment.
- **Platform()**: Sets up the platform for the experiment. Here, **SLURM** is used as the platform, specifying the job directory, partition name, account, and other parameters.

```python
    task.set_sif(manifest.SIF_PATH, platform)
```
- Sets the **Singularity Image File (SIF)** path for containerized execution on the SLURM platform.

```python
    task.common_assets.add_directory(os.path.join(manifest.input_dir, "example_weather", "out"), relative_path="climate")
```
- Adds the **weather data directory** as an asset to the task, providing necessary climate information for the simulation.

```python
    add_event_recorder(task, event_list=["HappyBirthday", "Births"], start_day=1, end_day=sim_years * 365, node_ids=[1], min_age_years=0, max_age_years=100)
```
- Adds an **event recorder** to the task to monitor specific events (`HappyBirthday`, `Births`) during the simulation for the specified duration.

```python
    add_malaria_summary_report(task, manifest, start_day=1, end_day=sim_years * 365, reporting_interval=30, age_bins=[0.25, 5, 115], max_number_reports=20, filename_suffix='monthly', pretty_format=True)
```
- Adds a **Malaria Summary Report** to the task to generate periodic reports (monthly) on the malaria transmission.

```python
    print("Creating EMODTask (from files)...")
```
- Prints a message indicating the creation of an EMODTask.

```python
    task = EMODTask.from_default2(
        config_path="config.json",
        eradication_path=manifest.eradication_path,
        campaign_builder=build_camp,
        schema_path=manifest.schema_file,
        param_custom_cb=set_param_fn,
        ep4_custom_cb=None,
        demog_builder=build_demog,
        plugin_report=None
    )
```
- **EMODTask.from_default2()**: Creates an EMODTask with specified configuration, eradication executable, campaign, schema, demographics, and parameters.

```python
    task.set_sif(manifest.SIF_PATH, platform)
```
- Sets the **SIF path** again for the task.

```python
    user = os.getlogin()
    experiment = Experiment.from_task(task, name= f'{user}_FE_example_basic')
```
- **os.getlogin()**: Retrieves the current user.
- **Experiment.from_task()**: Creates an experiment from the EMODTask.

```python
    experiment.run(wait_until_done=True, platform=platform)
```
- Runs the experiment on the specified platform and waits for it to finish.

```python
    if not experiment.succeeded:
        print(f"Experiment {experiment.uid} failed.\n")
        exit()

    print(f"Experiment {experiment.uid} succeeded.")
```
- Checks if the experiment succeeded and prints the result. If it failed, exits the script.

#### 6. Main Execution Block
```python
if __name__ == "__main__":
    import emod_malaria.bootstrap as dtk
    import pathlib

    dtk.setup(pathlib.Path(manifest.eradication_path).parent)
```
- The **main block** sets up the **eradication path** using `bootstrap` from `emod_malaria`.

```python
    selected_platform = "SLURM_LOCAL"
    general_sim(selected_platform)
```
- Sets the platform to `"SLURM_LOCAL"` and calls the `general_sim()` function to execute the experiment.

---








## Step 6: Run the Analyzer

```python
import os
import datetime
import pandas as pd
import numpy as np
import sys
import re
import random
from idmtools.entities import IAnalyzer
from idmtools.entities.simulation import Simulation
import manifest

## For plotting
import matplotlib.pyplot as plt
import matplotlib as mpl
import matplotlib.dates as mdates
```
- **`import os`**: Provides functions to interact with the operating system, such as file creation and directory handling.
- **`import datetime`**: Used for working with dates and times, essential for creating timestamps.
- **`import pandas as pd`**: Imports pandas for data analysis and manipulation; `pd` is the standard alias.
- **`import numpy as np`**: Imports numpy for numerical operations; commonly used for mathematical calculations.
- **`import sys`, `import re`, `import random`**: Imports basic Python libraries for system functions (`sys`), regular expressions (`re`), and generating random numbers (`random`).
- **`from idmtools.entities import IAnalyzer`**: Imports the `IAnalyzer` base class from idmtools, which is used to create custom analyzers for the simulations.
- **`from idmtools.entities.simulation import Simulation`**: Imports `Simulation` class to handle simulation-related operations.
- **`import manifest`**: Imports a `manifest` file that probably contains configuration and paths for files.
- **`import matplotlib.pyplot as plt`**: Imports `matplotlib` for plotting graphs, with `plt` as the alias.
- **`import matplotlib as mpl`**: Imports the base `matplotlib` module to access lower-level functions.
- **`import matplotlib.dates as mdates`**: For formatting date axes in plots.

### Define the `InsetChartAnalyzer` Class
```python
class InsetChartAnalyzer(IAnalyzer):
```
- **`class InsetChartAnalyzer(IAnalyzer):`**: Creates a class called `InsetChartAnalyzer`, inheriting from `IAnalyzer`. This class will be used to analyze simulation outputs.

#### `monthparser` Class Method
```python
    @classmethod
    def monthparser(self, x):
        if x == 0:
            return 12
        else:
            return datetime.datetime.strptime(str(x), '%j').month
```
- **`@classmethod`**: Declares `monthparser` as a class method that can be called on the class itself rather than an instance.
- **Purpose**: **Converts day-of-year (`%j`) into a month number**. If `x` is `0`, it returns `12` (December).
- **Reason**: Helps interpret time data, specifically day-of-year, in the context of months.

#### `__init__` Method for Initialization
```python
    def __init__(self, expt_name, sweep_variables=None, channels=None, working_dir=".", start_year=0):
        super(InsetChartAnalyzer, self).__init__(working_dir=working_dir, filenames=["output/InsetChart.json"])
        self.sweep_variables = sweep_variables or ["Run_Number"]
        self.inset_channels = channels or ['Statistical Population', 'New Clinical Cases', 'Blood Smear Parasite Prevalence', 'Infectious Vectors']
        self.expt_name = expt_name
        self.start_year = start_year
```
- **`def __init__(...)`**: Initializes an instance of `InsetChartAnalyzer`.
- **`super(...)`**: Calls the base class (`IAnalyzer`) constructor to initialize common parameters.
- **`working_dir`**: Sets the directory where the output will be stored.
- **`filenames=["output/InsetChart.json"]`**: Specifies the file to be analyzed.
- **`self.sweep_variables`**: Defines the sweep variables (e.g., parameters over which to vary simulation runs). Defaults to `Run_Number` if not specified.
- **`self.inset_channels`**: Sets the channels to analyze (e.g., metrics from the simulation output).
- **Purpose**: Sets up key parameters like output location, data sources, and sweep variables.

#### `map` Method to Extract Data
```python
    def map(self, data, simulation: Simulation):
        simdata = pd.DataFrame({x: data[self.filenames[0]]['Channels'][x]['Data'] for x in self.inset_channels})
        simdata['Time'] = simdata.index
        simdata['Day'] = simdata['Time'] % 365
        simdata['Year'] = simdata['Time'].apply(lambda x: int(x / 365) + self.start_year)
        simdata['date'] = simdata.apply(lambda x: datetime.date(int(x['Year']), 1, 1) + datetime.timedelta(int(x['Day']) - 1), axis=1)
```
- **`def map(self, data, simulation: Simulation):`**: Maps simulation data into a more usable form (i.e., a DataFrame).
- **`simdata = pd.DataFrame(...)`**: Extracts selected channels (`self.inset_channels`) from the data dictionary and creates a DataFrame.
- **`simdata['Time']`**: Adds a `Time` column based on the index, representing the simulation timestep.
- **`simdata['Day']`**: Calculates the day-of-year by using `Time % 365`.
- **`simdata['Year']`**: Converts the time into a year, accounting for `start_year`.
- **Purpose**: Converts time data into more human-readable formats like day and year.

#### `reduce` Method to Concatenate Data
```python
    def reduce(self, all_data):
        selected = [data for sim, data in all_data.items()]
        if len(selected) == 0:
            print("No data have been returned... Exiting...")
            return

        if not os.path.exists(os.path.join(self.working_dir, self.expt_name)):
            os.mkdir(os.path.join(self.working_dir, self.expt_name))

        adf = pd.concat(selected).reset_index(drop=True)
        adf.to_csv(os.path.join(self.working_dir, self.expt_name, 'All_Age_InsetChart.csv'), index=False)
```
- **`def reduce(...)`**: Reduces the mapped data across all simulations into a single file.
- **`selected = [data for sim, data in all_data.items()]`**: Collects data for all simulations.
- **`if len(selected) == 0:`**: Checks if there is any data to process; prints a warning if none.
- **Creates output directory**: If it doesn't already exist, create a folder for storing results.
- **`adf.to_csv(...)`**: Saves the concatenated data to a CSV file.
- **Purpose**: Collects data from multiple simulations, saves it for later use.

### Define `MonthlyPfPRAnalyzer` Class
This class performs more detailed analysis of malaria prevalence by month.

#### Initialization
```python
    def __init__(self, expt_name, sweep_variables=None, working_dir='./', start_year=0, burnin=None, filter_exists=False):
        super(MonthlyPfPRAnalyzer, self).__init__(working_dir=working_dir, filenames=["output/MalariaSummaryReport_monthly.json"])
        ...
```
- Similar to **`InsetChartAnalyzer`**, this sets parameters needed for the analysis, specifying a different JSON file (`MalariaSummaryReport_monthly.json`).

#### `filter` Method
```python
    def filter(self, simulation: Simulation):
        if self.filter_exists:
            file = os.path.join(simulation.get_path(), self.filenames[0])
            return os.path.exists(file)
        else:
            return True
```
- **`def filter(...)`**: Checks whether the specified file exists for the simulation.
- **Purpose**: Filters out simulations that do not have the necessary data files.

#### `map` Method
```python
    def map(self, data, simulation: Simulation):
        adf = pd.DataFrame()
        fname = self.filenames[0]
        age_bins = data[self.filenames[0]]['Metadata']['Age Bins']
        
        for age in range(len(age_bins)):
            d = data[fname]['DataByTimeAndAgeBins']['PfPR by Age Bin'][:-1]
            pfpr = [x[age] for x in d]
            ...
```
- **Extracts data for each age bin** from the JSON report, including various metrics like `PfPR`, `Annual Clinical Incidence`, etc.
- **Creates DataFrame** `simdata` for each metric and concatenates them into `adf`.
- **Purpose**: Extracts malaria prevalence and other metrics for different age groups, returning a consolidated DataFrame.

### Reduce Method for Monthly Analyzer
```python
    def reduce(self, all_data):
        selected = [data for sim, data in all_data.items()]
        if len(selected) == 0:
            print("\nWarning: No data have been returned... Exiting...")
            return

        if not os.path.exists(os.path.join(self.working_dir, self.expt_name)):
            os.mkdir(os.path.join(self.working_dir, self.expt_name))

        adf = pd.concat(selected).reset_index(drop=True)
        adf.to_csv(os.path.join(self.working_dir, self.expt_name, 'PfPR_ClinicalIncidence_monthly.csv'), index=False)
```
- **Concatenates all extracted data** and saves it as a CSV.
- **Purpose**: Generates a single consolidated CSV file containing malaria prevalence data for all simulations.

### Main Execution Section (`if __name__ == "__main__":`)
```python
if __name__ == "__main__":
```
- Runs only when the script is executed directly.

#### Set Experiment Variables and Directories
```python
    expts = {'week2_outputs' : '92e86035-aaf6-4cbf-be6d-6369586e6a2c'}
    jdir = manifest.job_directory
    wdir = os.path.join(jdir, 'my_outputs')
    if not os.path.exists(wdir):
        os.mkdir(wdir)
```
- **`expts`**: A dictionary mapping experiment names to IDs.
- **`jdir`** and **`wdir`**: Define job and working directories. Creates output directories if they do not exist.

#### Set Up Platform Context and Analyzers
```python
    with Platform('SLURM_LOCAL',job_directory=jdir) as platform:
        for expt_name, exp_id in expts.items():
            analyzer = [
                InsetChartAnalyzer(expt_name=expt_name, channels=channels_inset_chart, sweep_variables=sweep_variables, start_year=2023, working_dir=wdir),
                MonthlyPfPRAnalyzer(expt_name=expt_name, sweep_variables=sweep_variables, start_year=2023, working_dir=wdir)
            ]
```
- **`Platform('SLURM_LOCAL', job_directory=jdir)`**: Sets up a platform context (local execution on SLURM).
- **`analyzer` list**: Creates instances of both analyzers to process the experiment.

#### Analysis Manager
```python
            manager = AnalyzeManager(configuration={}, ids=[(exp_id, ItemType.EXPERIMENT)], analyzers=analyzer, partial_analyze_ok=True)
            manager.analyze()
```
- **`AnalyzeManager`**: Manages the analysis process for the specified analyzers and experiment IDs.
- **`manager.analyze()`**: Runs the analysis for all configured analyzers.

### Read and Plot Results
```python
    df = pd.read_csv(os.path.join(wdir, expt_name, 'All_Age_InsetChart.csv'))
    df['date'] = pd.to_datetime(df['date'])
    df = df.groupby(['date'] + sweep_variables)[channels_inset_chart].agg(np.mean).reset_index()
```
- **Reads the CSV output** from the analyzer.
- **Groups data by date and sweep variables** and calculates the average for each group.

#### Plotting Setup
```python
    fig1 = plt.figure('InsetChart', figsize=(12, 6))
    fig1.subplots_adjust(hspace=0.5, left=0.08, right=0.97)
    fig1.suptitle(f'Analyzer: InsetChartAnalyzer')
    axes = [fig1.add_subplot(2, 3, x + 1) for x in range(6)]
    for ch, channel in enumerate(channels_inset_chart):
        ax = axes[ch]
        for p, pdf in df.groupby(sweep_variables):
            ax.plot(pdf['date'], pdf[channel], '-', linewidth=0.8, label=p)
        ax.set_title(channel)
        ax.set_ylabel(channel)
        ax.xaxis.set_major_locator(mdates.MonthLocator(interval=12))
        ax.xaxis.set_major_formatter(mdates.DateFormatter('%Y'))
    if len(sweep_variables) > 0:
        axes[-1].legend(title=sweep_variables)
    fig1.savefig(os.path.join(wdir, expt_name, 'InsetChart.png'))
```
- **Sets up the plot** for each channel in `channels_inset_chart`.
- **Subplots**: Arranges each channel on a different subplot.
- **Plots each group's data** for each channel.
- **Formats x-axis** to show years instead of dates for better readability.
- **Saves the figure** in the output directory.

### Summary
- The script defines analyzers to process specific simulation outputs, convert them into a human-readable format, and save them.
- Analyzers are **executed through an `AnalyzeManager`**, which manages the workflow.
- The results are **saved as CSV** files and visualized using `matplotlib`.
- The script helps in **automating the analysis** of large-scale simulation data, enabling better insights.
